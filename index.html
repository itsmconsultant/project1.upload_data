<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload Excel</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }
    h1, h2 { margin-bottom: 10px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input[type="email"], input[type="password"], select, input[type="text"] {
      width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box;
    }
    .upload-area { border: 2px dashed #007bff; border-radius: 8px; padding: 40px;
                   text-align: center; cursor: pointer; margin-top: 15px; }
    .upload-area.dragover { border-color: #0056b3; background-color: #f0f7ff; }
    button { padding: 8px 16px; margin-top: 10px; border: none; border-radius: 4px; cursor: pointer; }
    button.primary { background-color: #007bff; color: #fff; }
    button.secondary { background-color: #6c757d; color: #fff; }
    button.danger { background-color: #dc3545; color: #fff; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #progressBarContainer { width: 100%; height: 16px; background: #eee; border-radius: 8px; margin-top: 10px; }
    #progressBar { height: 100%; width: 0%; background: linear-gradient(90deg,#007bff,#28a745); border-radius: 8px; transition: width 0.3s; }
    table { border-collapse: collapse; margin-top: 15px; white-space: nowrap; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f8f9fa; }
    .preview-wrapper { width: 100%; overflow-x: auto; }
    #status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px; }
    .status-info { background: #e2f0ff; color: #084298; border: 1px solid #b6d4fe; }
    .status-success { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .status-error { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    #metaInfo { margin-top: 8px; font-size: 13px; color: #555; }
  </style>
</head>
<body>

  <h1 id="pageTitle" style="display:none;">Upload Excel</h1>

  <!-- LOGIN -->
  <div id="loginSection" class="card" style="max-width:400px;margin:40px auto;">
    <h2>Login</h2>
    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="you@example.com">
    <label>Password</label>
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="btnLogin" class="primary">Login</button>
    <div id="loginStatus" style="margin-top:8px;font-size:13px;color:#b00;"></div>
  </div>

  <!-- APP -->
  <div id="appSection" style="display:none;">
    <div style="text-align:right;margin-bottom:10px;">
      <span id="userInfo" style="margin-right:10px;font-size:13px;color:#555;"></span>
      <button id="btnLogout" class="danger">Logout</button>
    </div>

    <div class="card">
      <h3>Konfigurasi</h3>
      <label>Pilih Tabel:</label>
      <select id="tableSelect"></select>
      <div id="metaInfo"></div>
    </div>

    <div class="card">
      <h3>Upload File Excel</h3>
      <div class="upload-area" id="uploadArea">
        <p><strong>Klik di sini</strong> atau drag file .xlsx/.xls/.csv ke area ini</p>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">
      </div>

      <div id="fileInfo"></div>

      <div id="progressSection" style="display:none;">
        <div>Progress: <span id="progressText">0 / 0</span> baris</div>
        <div id="progressBarContainer">
          <div id="progressBar"></div>
        </div>
      </div>

      <div id="previewSection" style="display:none;">
        <h4>Preview (10 baris pertama)</h4>
        <div id="previewTable"></div>
        <button class="primary" id="btnUpload">Upload ke Supabase</button>
        <button class="secondary" id="btnReset">Reset</button>
      </div>

      <div id="status"></div>
    </div>
  </div>

  <script>
    // ========== KONFIGURASI ==========
    const SUPABASE_URL = 'https://jyxbmligiunpchkfykjj.supabase.co';      // <-- GANTI
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5eGJtbGlnaXVucGNoa2Z5a2pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODU4MTksImV4cCI6MjA4MTA2MTgxOX0.82bKqOXPya8jqnp9grZcD9FJJ9kdRqWHXTfn39rryFs';         // <-- GANTI
    const TARGET_SCHEMA = 'project1';                            // schema tabel & view
    // ================================

    let supabaseClient = null;
    let excelRows = [];
    let excelHeaders = [];

    // metadata tipe kolom
    const tableColumnTypes = {};   // { tableName: { colName: 'date' | 'timestamp...' | 'other' } }

    function setStatus(msg, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = '';
      if (!msg) { statusDiv.textContent = ''; return; }
      if (type === 'success') statusDiv.classList.add('status-success');
      else if (type === 'error') statusDiv.classList.add('status-error');
      else statusDiv.classList.add('status-info');
      statusDiv.textContent = msg;
    }

    function normalizeHeader(header, idx) {
      return (header || `col_${idx}`)
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9_]/g, '_');
    }

    function formatTwo(n) { return String(n).padStart(2, '0'); }

    function toPgDate(value) {
      if (value == null || value === '') return null;

      // Serial Excel numeric
      if (typeof value === 'number') {
        const obj = XLSX.SSF.parse_date_code(value);
        if (!obj) return null;
        const y = obj.y;
        const m = formatTwo(obj.m);
        const d = formatTwo(obj.d);
        return `${y}-${m}-${d}`;
      }

      // Date object
      if (value instanceof Date) {
        const y = value.getFullYear();
        const m = formatTwo(value.getMonth() + 1);
        const d = formatTwo(value.getDate());
        return `${y}-${m}-${d}`;
      }

      // String: kalau sudah YYYY-MM-DD, pakai langsung
      const s = String(value).trim();
      if (!s) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      const dObj = new Date(s);
      if (isNaN(dObj.getTime())) return null;
      const y = dObj.getFullYear();
      const m = formatTwo(dObj.getMonth() + 1);
      const d = formatTwo(dObj.getDate());
      return `${y}-${m}-${d}`;
    }

    // versi pakai parse_date_code, tidak ada geser tanggal/jam
    function toPgTimestamp(value) {
      if (value == null || value === '') return null;

      // Serial Excel numeric
      if (typeof value === 'number') {
        const obj = XLSX.SSF.parse_date_code(value);
        if (!obj) return null;
        const y = obj.y;
        const mo = formatTwo(obj.m);
        const da = formatTwo(obj.d);
        const h  = formatTwo(obj.H);
        const mi = formatTwo(obj.M);
        const se = formatTwo(Math.round(obj.S));
        return `${y}-${mo}-${da} ${h}:${mi}:${se}`;
      }

      // Date object
      if (value instanceof Date) {
        const y  = value.getFullYear();
        const mo = formatTwo(value.getMonth() + 1);
        const da = formatTwo(value.getDate());
        const h  = formatTwo(value.getHours());
        const mi = formatTwo(value.getMinutes());
        const se = formatTwo(value.getSeconds());
        return `${y}-${mo}-${da} ${h}:${mi}:${se}`;
      }

      // String: kirim apa adanya
      const s = String(value).trim();
      if (!s) return null;
      return s;
    }

    function showLogin() {
      document.getElementById('pageTitle').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('appSection').style.display = 'none';
    }

    function showApp(user) {
      document.getElementById('pageTitle').style.display = 'block';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      document.getElementById('userInfo').textContent =
        user?.email ? `Login sebagai: ${user.email}` : '';
      initUploadUI();
    }

    async function initUploadUI() {
      await loadTables();
      const tableSelect = document.getElementById('tableSelect');
      if (tableSelect.value) await loadColumnTypes(tableSelect.value);

      tableSelect.addEventListener('change', () => loadColumnTypes(tableSelect.value));

      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');

      uploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFile);

      ['dragover','dragenter'].forEach(evt => {
        uploadArea.addEventListener(evt, e => {
          e.preventDefault();
          uploadArea.classList.add('dragover');
        });
      });
      ['dragleave','drop'].forEach(evt => {
        uploadArea.addEventListener(evt, e => {
          e.preventDefault();
          uploadArea.classList.remove('dragover');
        });
      });
      uploadArea.addEventListener('drop', e => {
        handleFile({ target: { files: e.dataTransfer.files } });
      });

      document.getElementById('btnUpload').addEventListener('click', uploadToSupabase);
      document.getElementById('btnReset').addEventListener('click', () => location.reload());
    }

    window.addEventListener('DOMContentLoaded', async () => {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user) {
        showApp(session.user);
      } else {
        showLogin();
      }

      document.getElementById('btnLogin').addEventListener('click', doLogin);
      document.getElementById('btnLogout').addEventListener('click', doLogout);
    });

    async function doLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const status = document.getElementById('loginStatus');

      status.textContent = 'Logging in...';

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        status.textContent = 'Error: ' + error.message;
        return;
      }
      status.textContent = '';
      showApp(data.user);
    }

    async function doLogout() {
      await supabaseClient.auth.signOut();
      location.reload();
    }

    async function loadTables() {
      const tableSelect = document.getElementById('tableSelect');
      const metaInfo = document.getElementById('metaInfo');
      tableSelect.innerHTML = '';
      metaInfo.textContent = 'Mengambil daftar tabel...';

      try {
        const { data, error } = await supabaseClient
          .schema(TARGET_SCHEMA)
          .from('v_table_list')
          .select('table_name')
          .in('table_name',['saldo_durian','settlement','deposit','balance_id'])
          .order('table_name');

        if (error) throw error;

        if (!data || data.length === 0) {
          metaInfo.textContent = 'Tidak ada tabel.';
          return;
        }

        data.forEach(row => {
          const opt = document.createElement('option');
          opt.value = row.table_name;
          opt.textContent = row.table_name;
          tableSelect.appendChild(opt);
        });

        metaInfo.textContent =
          'Tabel terdeteksi: ' + data.map(r => r.table_name).join(', ');
      } catch (e) {
        setStatus('Gagal membaca daftar tabel: ' + e.message, 'error');
        metaInfo.textContent = '';
      }
    }

    async function loadColumnTypes(tableName) {
      const metaInfo = document.getElementById('metaInfo');
      if (!tableName || !supabaseClient) return;

      setStatus(`Mengambil metadata kolom untuk ${tableName}...`, 'info');

      try {
        const { data, error } = await supabaseClient
          .schema(TARGET_SCHEMA)
          .from('v_date_columns')
          .select('column_name, data_type')
          .eq('table_name', tableName);

        if (error) throw error;

        const colMap = {};
        const dateCols = [];
        const tsCols = [];

        (data || []).forEach(c => {
          const name = c.column_name.toLowerCase();
          colMap[name] = c.data_type;
          if (c.data_type === 'date') dateCols.push(name);
          else tsCols.push(name);
        });

        tableColumnTypes[tableName] = colMap;

        setStatus(`Metadata ${tableName} OK.`, 'success');
        metaInfo.textContent =
          `Tabel: ${tableName} | Kolom date: ${dateCols.join(', ') || '-'} | Kolom timestamp: ${tsCols.join(', ') || '-'}`;
      } catch (e) {
        tableColumnTypes[tableName] = {};
        setStatus('Gagal membaca metadata kolom: ' + e.message, 'error');
      }
    }

    async function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('fileInfo').textContent =
        `File: ${file.name} (${Math.round(file.size/1024)} KB)`;
      setStatus('Membaca file Excel...', 'info');

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const data = new Uint8Array(evt.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });

          if (!rows || rows.length === 0) {
            setStatus('Sheet kosong.', 'error');
            return;
          }

          excelHeaders = rows[0];
          excelRows = rows.slice(1);

          renderPreview();
          setStatus(`File terbaca. ${excelRows.length} baris data.`, 'success');
        } catch (err) {
          setStatus('Error membaca file: ' + err.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function renderPreview() {
      const previewSection = document.getElementById('previewSection');
      const previewTableDiv = document.getElementById('previewTable');
      previewSection.style.display = 'block';

      const tableName = document.getElementById('tableSelect').value || '';
      const colTypes = tableColumnTypes[tableName] || {};

      let html = '<div class="preview-wrapper"><table><thead><tr>';
      excelHeaders.forEach((h, i) => {
        html += `<th>${h || 'Col' + i}</th>`;
      });
      html += '</tr></thead><tbody>';

      excelRows.slice(0, 10).forEach(row => {
        html += '<tr>';
        excelHeaders.forEach((header, idx) => {
          const colName = normalizeHeader(header, idx);
          const type = colTypes[colName] || 'other';
          let val = row[idx];

          if (type === 'date') {
            const converted = toPgDate(val);
            val = converted || val;
          } else if (type.startsWith('timestamp')) {
            const converted = toPgTimestamp(val);
            val = converted || val;
          }

          if (val == null) val = '';
          html += `<td>${val}</td>`;
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';

      previewTableDiv.innerHTML = html;
    }

    async function uploadToSupabase() {
      const tableName = document.getElementById('tableSelect').value;
      if (!tableName) {
        setStatus('Pilih tabel tujuan terlebih dahulu.', 'error');
        return;
      }
      if (!excelRows.length) {
        setStatus('Tidak ada data untuk diupload.', 'error');
        return;
      }

      const progressSection = document.getElementById('progressSection');
      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');

      progressSection.style.display = 'block';
      setStatus(`Mulai upload ke tabel "${tableName}"...`, 'info');

      const BATCH_SIZE = 100;
      let processed = 0;
      const total = excelRows.length;

      const colTypes = tableColumnTypes[tableName] || {};

      try {
        for (let i = 0; i < total; i += BATCH_SIZE) {
          const batchRows = excelRows.slice(i, i + BATCH_SIZE);

          const payload = batchRows.map(row => {
            const obj = {};
            excelHeaders.forEach((header, idx) => {
              const colName = normalizeHeader(header, idx);
              const type = colTypes[colName] || 'other';
              let value = (row[idx] === undefined ? null : row[idx]);

              if (type === 'date') {
                value = toPgDate(value);
              } else if (type.startsWith('timestamp')) {
                value = toPgTimestamp(value);
              }

              obj[colName] = value;
            });
            return obj;
          });

          const { error } = await supabaseClient
            .schema(TARGET_SCHEMA)
            .from(tableName)
            .insert(payload);

          if (error) throw error;

          processed += batchRows.length;
          progressText.textContent = `${processed} / ${total}`;
          progressBar.style.width = `${(processed / total) * 100}%`;
        }

        setStatus(`Upload selesai. ${processed} baris berhasil diinsert ke tabel "${tableName}".`, 'success');
      } catch (err) {
        setStatus('Error saat upload: ' + err.message, 'error');
      }
    }
  </script>
</body>
</html>

