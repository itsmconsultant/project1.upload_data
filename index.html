<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Upload Excel to Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; }
    h1, h2 { margin-bottom: 10px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input[type="email"], input[type="password"], select, input[type="text"] {
      width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box;
    }
    .upload-area { border: 2px dashed #007bff; border-radius: 8px; padding: 40px;
                   text-align: center; cursor: pointer; margin-top: 15px; }
    .upload-area.dragover { border-color: #0056b3; background-color: #f0f7ff; }
    button { padding: 8px 16px; margin-top: 10px; border: none; border-radius: 4px; cursor: pointer; }
    button.primary { background-color: #007bff; color: #fff; }
    button.secondary { background-color: #6c757d; color: #fff; }
    button.danger { background-color: #dc3545; color: #fff; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #progressBarContainer { width: 100%; height: 16px; background: #eee; border-radius: 8px; margin-top: 10px; }
    #progressBar { height: 100%; width: 0%; background: linear-gradient(90deg,#007bff,#28a745); border-radius: 8px; transition: width 0.3s; }
    table { border-collapse: collapse; margin-top: 15px; white-space: nowrap; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 13px; }
    th { background: #f8f9fa; }
    .preview-wrapper { width: 100%; overflow-x: auto; }
    #status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px; min-height: 20px; }
    .status-info { background: #e2f0ff; color: #084298; border: 1px solid #b6d4fe; }
    .status-success { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .status-error { background: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    #metaInfo { margin-top: 8px; font-size: 13px; color: #555; }
  </style>
</head>
<body>

  <h1 id="pageTitle" style="display:none;">Upload Excel</h1>

  <div id="loginSection" class="card" style="max-width:400px;margin:40px auto;">
    <h2>Login</h2>
    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="you@example.com">
    <label>Password</label>
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="btnLogin" class="primary">Login</button>
    <div id="loginStatus" style="margin-top:8px;font-size:13px;color:#b00;"></div>
  </div>

  <div id="appSection" style="display:none;">
    <div style="text-align:right;margin-bottom:10px;">
      <span id="userInfo" style="margin-right:10px;font-size:13px;color:#555;"></span>
      <button id="btnLogout" class="danger">Logout</button>
    </div>

    <div class="card">
      <h3>Konfigurasi</h3>
      <label>Pilih Tabel:</label>
      <select id="tableSelect"></select>
      <div id="metaInfo"></div>
    </div>

    <div class="card">
      <h3>Upload File Excel</h3>
      <div class="upload-area" id="uploadArea">
        <p><strong>Klik di sini</strong> atau drag file .xlsx/.xls/.csv ke area ini</p>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">
      </div>

      <div id="fileInfo"></div>

      <div id="progressSection" style="display:none;">
        <div>Progress: <span id="progressText">0 / 0</span> baris</div>
        <div id="progressBarContainer">
          <div id="progressBar"></div>
        </div>
      </div>

      <div id="previewSection" style="display:none;">
        <h4>Preview (10 baris pertama)</h4>
        <div id="previewTable"></div>
        <button class="primary" id="btnUpload">Upload ke Supabase</button>
        <button class="secondary" id="btnReset">Reset</button>
      </div>

      <div id="status"></div>
    </div>
  </div>

  <script>
    // ========== KONFIGURASI ==========
    const SUPABASE_URL = 'https://jyxbmligiunpchkfykjj.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5eGJtbGlnaXVucGNoa2Z5a2pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODU4MTksImV4cCI6MjA4MTA2MTgxOX0.82bKqOXPya8jqnp9grZcD9FJJ9kdRqWHXTfn39rryFs'; // <--- PASTIKAN KEY BENAR
    const TARGET_SCHEMA = 'project1';
    // ================================

    let supabaseClient = null;
    let excelRows = [];
    let excelHeaders = [];
    const tableColumnTypes = {};  
    const tablePrimaryKeys = {}; 

    // --- UTILITY FUNCTIONS ---
    function setStatus(msg, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = '';
      if (!msg) { statusDiv.textContent = ''; return; }
      if (type === 'success') statusDiv.classList.add('status-success');
      else if (type === 'error') statusDiv.classList.add('status-error');
      else statusDiv.classList.add('status-info');
      statusDiv.textContent = msg;
    }

    function normalizeHeader(header, idx) {
      return (header || `col_${idx}`).toString().trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
    }

    function formatTwo(n) { return String(n).padStart(2, '0'); }

    function toPgDate(value) {
      if (value == null || value === '') return null;
      if (typeof value === 'number') {
        const obj = XLSX.SSF.parse_date_code(value);
        return obj ? `${obj.y}-${formatTwo(obj.m)}-${formatTwo(obj.d)}` : null;
      }
      const dObj = new Date(value);
      return isNaN(dObj.getTime()) ? null : `${dObj.getFullYear()}-${formatTwo(dObj.getMonth()+1)}-${formatTwo(dObj.getDate())}`;
    }

    function toPgTimestamp(value) {
      if (value == null || value === '') return null;
      if (typeof value === 'number') {
        const obj = XLSX.SSF.parse_date_code(value);
        return obj ? `${obj.y}-${formatTwo(obj.m)}-${formatTwo(obj.d)} ${formatTwo(obj.H)}:${formatTwo(obj.M)}:${formatTwo(Math.round(obj.S))}` : null;
      }
      return String(value).trim() || null;
    }

    // --- AUTH LOGIC ---
    window.addEventListener('DOMContentLoaded', async () => {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user) showApp(session.user);
      else showLogin();

      document.getElementById('btnLogin').addEventListener('click', doLogin);
      document.getElementById('btnLogout').addEventListener('click', doLogout);
    });

    async function doLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) { document.getElementById('loginStatus').textContent = error.message; return; }
      showApp(data.user);
    }

    async function doLogout() { await supabaseClient.auth.signOut(); location.reload(); }

    function showLogin() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('appSection').style.display = 'none';
    }

    function showApp(user) {
      document.getElementById('pageTitle').style.display = 'block';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      document.getElementById('userInfo').textContent = `Login: ${user.email}`;
      initUploadUI();
    }

    // --- CORE LOGIC ---
    async function initUploadUI() {
      await loadTables();
      const tableSelect = document.getElementById('tableSelect');
      tableSelect.addEventListener('change', () => loadColumnTypes(tableSelect.value));
      
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFile);
      
      document.getElementById('btnUpload').addEventListener('click', uploadToSupabase);
      document.getElementById('btnReset').addEventListener('click', () => location.reload());
    }

    async function loadTables() {
      const tableSelect = document.getElementById('tableSelect');
      try {
        const { data, error } = await supabaseClient
          .schema(TARGET_SCHEMA)
          .from('v_table_list')
          .select('table_name')
          .in('table_name', ['saldo_durian', 'settlement', 'deposit', 'disbursement'])
          .order('table_name');

        if (error) throw error;
        data.forEach(row => {
          const opt = document.createElement('option');
          opt.value = row.table_name;
          opt.textContent = row.table_name;
          tableSelect.appendChild(opt);
        });
        if (tableSelect.value) loadColumnTypes(tableSelect.value);
      } catch (e) { setStatus('Gagal load tabel: ' + e.message, 'error'); }
    }

    async function loadColumnTypes(tableName) {
      const metaInfo = document.getElementById('metaInfo');
      setStatus(`Mengambil metadata ${tableName}...`, 'info');
      try {
        // Ambil tipe kolom
        const { data: cols } = await supabaseClient.schema(TARGET_SCHEMA).from('v_date_columns').select('column_name, data_type').eq('table_name', tableName);
        const colMap = {};
        (cols || []).forEach(c => colMap[c.column_name.toLowerCase()] = c.data_type);
        tableColumnTypes[tableName] = colMap;

        // Ambil Primary Key
        const { data: pkData } = await supabaseClient.schema(TARGET_SCHEMA).from('v_primary_keys').select('pk_column').eq('table_name', tableName).maybeSingle();
        tablePrimaryKeys[tableName] = pkData ? pkData.pk_column : 'id_internal';

        metaInfo.textContent = `Tabel: ${tableName} | PK: ${tablePrimaryKeys[tableName]}`;
        setStatus(`Metadata OK.`, 'success');
      } catch (e) { setStatus('Gagal load metadata.', 'error'); }
    }

    async function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, blankrows: false });
        excelHeaders = rows[0];
        excelRows = rows.slice(1);
        renderPreview();
        setStatus(`File terbaca: ${excelRows.length} baris.`, 'success');
      };
      reader.readAsArrayBuffer(file);
    }

    function renderPreview() {
      const previewTableDiv = document.getElementById('previewTable');
      document.getElementById('previewSection').style.display = 'block';
      const colTypes = tableColumnTypes[document.getElementById('tableSelect').value] || {};
      let html = '<div class="preview-wrapper"><table><thead><tr>';
      excelHeaders.forEach(h => html += `<th>${h}</th>`);
      html += '</tr></thead><tbody>';
      excelRows.slice(0, 10).forEach(row => {
        html += '<tr>';
        excelHeaders.forEach((h, i) => {
          const type = colTypes[normalizeHeader(h, i)] || 'other';
          let val = row[i];
          if (type === 'date') val = toPgDate(val) || val;
          else if (type.startsWith('timestamp')) val = toPgTimestamp(val) || val;
          html += `<td>${val ?? ''}</td>`;
        });
        html += '</tr>';
      });
      previewTableDiv.innerHTML = html + '</tbody></table></div>';
    }

    async function uploadToSupabase() {
      const tableName = document.getElementById('tableSelect').value;
      const pkName = tablePrimaryKeys[tableName] || 'id_internal';
      const total = excelRows.length;
      const BATCH_SIZE = 100;
      let processed = 0;
      let insertedIds = [];

      document.getElementById('progressSection').style.display = 'block';
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      try {
        for (let i = 0; i < total; i += BATCH_SIZE) {
          const batchRows = excelRows.slice(i, i + BATCH_SIZE);
          const payload = batchRows.map(row => {
            const obj = {};
            excelHeaders.forEach((header, idx) => {
              const colName = normalizeHeader(header, idx);
              if (colName === pkName) return; // Database isi otomatis
              const type = (tableColumnTypes[tableName] || {})[colName] || 'other';
              let val = row[idx] === undefined ? null : row[idx];
              if (type === 'date') val = toPgDate(val);
              else if (type.startsWith('timestamp')) val = toPgTimestamp(val);
              obj[colName] = val;
            });
            return obj;
          });

          const { data, error } = await supabaseClient.schema(TARGET_SCHEMA).from(tableName).insert(payload).select(pkName);
          if (error) throw error;
          if (data) insertedIds.push(...data.map(d => d[pkName]));

          processed += batchRows.length;
          progressText.textContent = `${processed} / ${total}`;
          progressBar.style.width = `${(processed / total) * 100}%`;
        }
        setStatus(`Upload Sukses! ${processed} baris masuk.`, 'success');
      } catch (err) {
        setStatus(`Error: ${err.message}. Memulai rollback...`, 'error');
        if (insertedIds.length > 0) {
          const { error: rbErr } = await supabaseClient.schema(TARGET_SCHEMA).from(tableName).delete().in(pkName, insertedIds);
          setStatus(`Error: ${err.message}. Rollback ${rbErr ? 'Gagal' : 'Berhasil'}.`, 'error');
        }
        progressBar.style.background = 'red';
      }
    }
  </script>
</body>
</html>
